<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListForge - Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #000000;
        }
        .profile-card {
            background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);
            transition: all 0.3s ease;
        }
        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        .download-card {
            background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%);
            transition: all 0.3s ease;
            border: 1px solid #333;
        }
        .download-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border-color: #555;
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-black flex flex-col p-4">
        <!-- Header with back button -->
        <header class="w-full flex justify-between items-center mb-8">
            <a href="/membership.html" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back to Membership
            </a>
        </header>

        <div class="max-w-4xl mx-auto w-full">
            <!-- User Profile Section -->
            <div class="profile-card rounded-2xl p-8 border border-gray-800 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="bg-gray-700 rounded-full p-4 mr-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-white" id="profile-username">Username</h1>
                            <p class="text-gray-400" id="profile-email">user@example.com</p>
                        </div>
                    </div>
                    <button 
                        onclick="logout()"
                        class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors"
                    >
                        Sign Out
                    </button>
                </div>
                
                <!-- Account Information -->
                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-white mb-4">Account Information</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-400 text-sm">Username</p>
                            <p class="text-white" id="account-username">Username</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">Email</p>
                            <p class="text-white" id="account-email">user@example.com</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">Member Since</p>
                            <p class="text-white" id="account-created">January 1, 2023</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">Membership Status</p>
                            <p class="text-white" id="account-status">Free Member</p>
                        </div>
                    </div>
                </div>
                
                <!-- Subscription Information -->
                <div id="subscription" class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-white mb-4">Subscription Details</h2>
                    <div id="no-subscription" class="hidden">
                        <p class="text-gray-300 mb-4">You don't have an active subscription.</p>
                        <a href="/membership.html" class="inline-block bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            View Membership Options
                        </a>
                    </div>
                    <div id="active-subscription" class="hidden">
                        <div class="grid md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-gray-400 text-sm">Plan</p>
                                <p class="text-white" id="sub-plan">Monthly</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Status</p>
                                <p class="text-green-500 font-bold" id="sub-status">Active</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Next Payment</p>
                                <p class="text-white" id="sub-expiration">January 1, 2024</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Payment Method</p>
                                <p class="text-white" id="sub-payment">PayPal</p>
                            </div>
                        </div>
                        <div class="border-t border-gray-700 pt-4">
                            <p class="text-gray-300 mb-4">To cancel or modify your subscription, please visit your PayPal account.</p>
                            <a href="https://www.paypal.com/myaccount/autopay/" target="_blank" class="inline-block bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                Manage in PayPal
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Password Change Section -->
                <div class="bg-gray-800 rounded-xl p-6 mb-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-white">Change Password</h2>
                        <button 
                            id="togglePasswordForm" 
                            class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
                        >
                            Change Password
                        </button>
                    </div>
                    <form id="passwordChangeForm" class="space-y-4 mt-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">New Password</label>
                            <input type="password" id="newPassword" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">Confirm New Password</label>
                            <input type="password" id="confirmPassword" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button 
                                type="button" 
                                id="cancelPasswordChange" 
                                class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
                            >
                                Cancel
                            </button>
                            <button 
                                type="submit" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
                            >
                                Update Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Download Section -->
            <div class="profile-card rounded-2xl p-8 border border-gray-800">
                <h2 class="text-2xl font-bold text-white mb-6">Download ListForge App</h2>
                <p class="text-gray-400 mb-6">
                    Get the ListForge app for your device to access your lists anywhere, anytime.
                </p>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Windows Download -->
                    <div class="download-card rounded-xl p-6 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L7.586 10 5.293 7.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" />
                        </svg>
                        <h3 class="text-lg font-bold text-white mb-2">Windows</h3>
                        <p class="text-gray-400 text-sm mb-4">Windows 10 or later</p>
                        <a href="/download/windows" class="inline-block bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg w-full" 
                           onclick="showNotification('Windows download started', 'success');">
                            Download for Windows
                        </a>
                    </div>
                    
                    <!-- macOS Download -->
                    <div class="download-card rounded-xl p-6 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                        </svg>
                        <h3 class="text-lg font-bold text-white mb-2">macOS</h3>
                        <p class="text-gray-400 text-sm mb-4">macOS 11 or later</p>
                        <a href="/download/mac" class="inline-block bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg w-full"
                           onclick="showNotification('Mac download started', 'success');">
                            Download for Mac
                        </a>
                    </div>
                </div>
                
                <!-- Version info -->
                <div class="text-center mt-4">
                    <p class="text-gray-400 text-sm">Current version: v1.3.3.0</p>
                </div>
                
                <!-- Mobile Apps -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold text-white mb-4">Mobile Apps</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- iOS App -->
                        <div class="download-card rounded-xl p-6 flex items-center">
                            <div class="bg-gray-700 rounded-full p-3 mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7zm3 14a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white mb-1">iOS App</h3>
                                <p class="text-gray-400 text-sm mb-3">iPhone and iPad</p>
                                <a href="https://apps.apple.com/us/app/listforge/id6739130347" target="_blank" class="inline-block bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                    Download on App Store
                                </a>
                            </div>
                        </div>
                        
                        <!-- Android App -->
                        <div class="download-card rounded-xl p-6 flex items-center">
                            <div class="bg-gray-700 rounded-full p-3 mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7 2a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V4a2 2 0 00-2-2H7zm3 14a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white mb-1">Android App</h3>
                                <p class="text-gray-400 text-sm mb-3">Android 8.0 or later</p>
                                <a href="https://play.google.com/store/apps/details?id=io.codeseed.list_forge" target="_blank" class="inline-block bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                                    Download on Google Play
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication immediately when page loads
        const token = localStorage.getItem('token');
        console.log('Token exists:', !!token);
        
        if (!token) {
            console.log('No token found, redirecting to login');
            window.location.href = '/login.html';
        }

        // Function to download a file using a hidden iframe and show notification
        function downloadFile(url, platform) {
            console.log(`Initiating ${platform} download from: ${url}`);
            
            try {
                // Open the download in a new tab but focus remains on current page
                const downloadWindow = window.open(url, '_blank');
                
                // Immediately blur focus from the new window so user stays on current page
                if (downloadWindow) {
                    console.log(`${platform} download window opened successfully`);
                    downloadWindow.blur();
                    window.focus();
                } else {
                    console.error(`${platform} download window failed to open - may be blocked by popup blocker`);
                }
                
                // Show notification
                showNotification(`${platform} download started - select the appropriate file from GitHub`, 'success');
            } catch (error) {
                console.error(`Error starting ${platform} download:`, error);
                showNotification(`Error starting download: ${error.message}`, 'error');
            }
        }

        // Get user data and update profile
        fetch('/auth/check', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            console.log('Auth check response status:', response.status);
            if (!response.ok) {
                throw new Error('Authentication failed');
            }
            return response.json();
        })
        .then(data => {
            console.log('Authentication successful, full data:', data);
            
            // Update username in welcome message
            const usernameElement = document.getElementById('profile-username');
            if (data.username) {
                console.log('Setting username to:', data.username);
                usernameElement.textContent = data.username;
            } else {
                console.log('No username found in data, using default');
                usernameElement.textContent = 'Member';
            }
            
            // Update email
            const emailElement = document.getElementById('profile-email');
            if (data.email) {
                console.log('Setting email to:', data.email);
                emailElement.textContent = data.email;
            } else {
                console.log('No email found in data, using default');
                emailElement.textContent = 'user@example.com';
            }
            
            // Update account information
            const accountUsername = document.getElementById('account-username');
            if (data.username) {
                console.log('Setting account username to:', data.username);
                accountUsername.textContent = data.username;
            } else {
                console.log('No account username found in data, using default');
                accountUsername.textContent = 'Member';
            }
            
            // Update email in account information
            const accountEmail = document.getElementById('account-email');
            if (data.email) {
                console.log('Setting account email to:', data.email);
                accountEmail.textContent = data.email;
            } else {
                console.log('No account email found in data, using default');
                accountEmail.textContent = 'user@example.com';
            }
            
            // Format created date if available
            const accountCreated = document.getElementById('account-created');
            if (data.createdAt) {
                console.log('Setting account created date to:', data.createdAt._seconds * 1000);
                const createdDate = new Date(data.createdAt._seconds * 1000);
                accountCreated.textContent = createdDate.toLocaleDateString();
            } else {
                console.log('No account created date found in data, using default');
                accountCreated.textContent = 'N/A';
            }
            
            // Update account status
            const accountStatus = document.getElementById('account-status');
            if (data.subscription && data.subscription.status === 'active') {
                console.log('Setting account status to: Premium Member');
                accountStatus.textContent = 'Premium Member';
                accountStatus.classList.add('text-blue-500');
                
                // Show active subscription details
                document.getElementById('no-subscription').classList.add('hidden');
                document.getElementById('active-subscription').classList.remove('hidden');
                
                // Update subscription details
                const subPlan = document.getElementById('sub-plan');
                if (data.subscription.paymentProvider === 'promo') {
                    // Calculate duration in days between start and expiry
                    if (data.subscription.startDate && data.subscription.expiryDate) {
                        const startDate = new Date(data.subscription.startDate._seconds * 1000);
                        const expiryDate = new Date(data.subscription.expiryDate._seconds * 1000);
                        const durationDays = Math.round((expiryDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        // Determine plan name based on duration
                        if (durationDays >= 360 && durationDays <= 370) {
                            console.log('Setting subscription plan to: 1 Year');
                            subPlan.textContent = '1 Year';
                        } else if (durationDays >= 85 && durationDays <= 95) {
                            console.log('Setting subscription plan to: 3 Months');
                            subPlan.textContent = '3 Months';
                        } else if (durationDays >= 28 && durationDays <= 32) {
                            console.log('Setting subscription plan to: 1 Month');
                            subPlan.textContent = '1 Month';
                        } else {
                            console.log(`Setting subscription plan to: ${durationDays} Days`);
                            subPlan.textContent = `${durationDays} Days`;
                        }
                    } else {
                        console.log('Setting subscription plan to: Promotional');
                        subPlan.textContent = 'Promotional';
                    }
                } else if (data.subscription.plan === 'yearly') {
                    console.log('Setting subscription plan to: Yearly');
                    subPlan.textContent = 'Yearly';
                } else {
                    console.log('Setting subscription plan to: Monthly');
                    subPlan.textContent = 'Monthly';
                }
                
                const subStatus = document.getElementById('sub-status');
                console.log('Setting subscription status to: Active');
                subStatus.textContent = 'Active';
                subStatus.classList.add('text-blue-500');
                
                // Format expiration date
                const subExpiration = document.getElementById('sub-expiration');
                if (data.subscription.expirationDate) {
                    console.log('Setting subscription expiration date to:', data.subscription.expirationDate._seconds * 1000);
                    const expirationDate = new Date(data.subscription.expirationDate._seconds * 1000);
                    subExpiration.textContent = expirationDate.toLocaleDateString();
                } else {
                    console.log('No subscription expiration date found in data, using default');
                    subExpiration.textContent = 'N/A';
                }
                
                const subPayment = document.getElementById('sub-payment');
                console.log('Setting subscription payment method to:', data.subscription.paymentProvider);
                if (data.subscription.paymentProvider === 'paypal') {
                    console.log('Setting subscription payment method to: PayPal');
                    subPayment.textContent = 'PayPal';
                } else if (data.subscription.paymentProvider === 'promo') {
                    console.log('Setting subscription payment method to: Promo Code');
                    subPayment.textContent = 'Promo Code';
                } else {
                    console.log('Setting subscription payment method to: Credit Card');
                    subPayment.textContent = 'Credit Card';
                }
            } else {
                console.log('Setting account status to: Free Member');
                accountStatus.textContent = 'Free Member';
                accountStatus.classList.remove('text-blue-500');
                
                // Show no subscription message
                document.getElementById('no-subscription').classList.remove('hidden');
                document.getElementById('active-subscription').classList.add('hidden');
            }
        })
        .catch(error => {
            console.error('Auth check error:', error);
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });

        function logout() {
            localStorage.removeItem('token');
            fetch('/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).then(() => {
                window.location.href = '/login.html';
            });
        }

        // Password change form toggle
        const togglePasswordForm = document.getElementById('togglePasswordForm');
        const passwordChangeForm = document.getElementById('passwordChangeForm');
        const cancelPasswordChange = document.getElementById('cancelPasswordChange');

        togglePasswordForm.addEventListener('click', () => {
            passwordChangeForm.classList.remove('hidden');
            togglePasswordForm.classList.add('hidden');
        });

        cancelPasswordChange.addEventListener('click', () => {
            passwordChangeForm.classList.add('hidden');
            togglePasswordForm.classList.remove('hidden');
            passwordChangeForm.reset();
        });

        // Password change form handling
        passwordChangeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 6) {
                showNotification('New password must be at least 6 characters long', 'error');
                return;
            }
            
            try {
                const response = await fetch('/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ newPassword })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('Password updated successfully', 'success');
                    // Hide form and reset
                    passwordChangeForm.classList.add('hidden');
                    togglePasswordForm.classList.remove('hidden');
                    passwordChangeForm.reset();
                } else {
                    showNotification(data.error || 'Failed to update password', 'error');
                }
            } catch (error) {
                console.error('Password change error:', error);
                showNotification('An error occurred while changing password', 'error');
            }
        });

        // Helper function to show notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-blue-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html> 